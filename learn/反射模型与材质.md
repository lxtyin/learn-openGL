#### BRDF

BRDF == 材质

出射光的颜色总是为 $BRDF\times L_i$，故计算BRDF时不需要考虑入射光的颜色。

**线性：**BRDF若有多个部分，可以把它们叠加起来计算。

**可逆性：**$f_r(w_r\rightarrow w_i)=f_r(w_i\rightarrow w_r)$

**能量守恒：**总量可以衰减（吸收），但不能多，这决定了光线追踪是否能够收敛（物理上的正确性）。

**各向同性与各向异性：**各个方向上的BRDF是否有对称性，各向同性的BRDF在测量和存储上能够减少不少消耗。



BRDF有多种实现形式，下面使用最常见的 `Cook-Torrance BRDF` 模型：

$f_r=k_df_{lambert}+k_sf_{cook-torrance}$

其中 $k_d, k_s$ 取决于物体的金属度 `metallic`，$k_d=1-metallic$，$k_s=metallic$，这用到了上述说的线性性质，保持能量守恒。



**漫反射**部分也有很多实现：

- 最简单的Lambert漫反射：$f_{lambert}=\frac{c}{\pi}$
- 加上次表面散射的

**镜面反射**则普遍具有如下形式：
$$
f_{cook-torrance}=\frac{DFG}{4(w_o\cdot n)(w_i\cdot n)}
$$
$D(h)$ 法线分布项：法线与半程向量 $h$ 一致的微平面比例，决定了镜面反射的强度。

$G$ 几何项：表示微表面之间互相遮挡导致的损失项，在光线接近平行时，损失较大。

$F$ 菲涅尔项：描述在不同角度下表面反射光线的比例。

上述仅仅是定义式，这三个项又有许多不同的实现方法。

##### D：Trowbridge-Reitz GGX

$$
NDF_{GGXTR}(h)=\frac{\alpha^2}{\pi((n\cdot h)^2(\alpha^2-1)+1)^2}
$$

式子中 $\alpha$ 表示粗糙程度 `roughness` ，其值越大，反射越不集中。

更精确的，$D(h)$ 是指垂直于 $h$ 的微平面面积与宏表面积的比值，实际应满足 $\int_{\Omega^+} D(h)cos\theta_hd_w=1$，$\theta_h$ 为宏面法线和 $h$ 的夹角，具体见下图：

![](https://img2020.cnblogs.com/blog/519775/202010/519775-20201010225605808-1680627455.png)

###### 对GGX进行重要性采样

我们很难严格画出渲染方程的曲线，故通常只对法线分布函数进行重要性采样。

由于 $\int_{\Omega^+} D(h)cos\theta_hd_w=1$，那太方便了，直接拿 $D(h)cos\theta_h$ 当概率密度。

将向量转化到球面坐标系 $\theta,\phi$，显然这里的式子与 $\phi$ 无关，我们可以得到 $pdf(\theta)=\frac{2\alpha^2cos\theta}{(cos^2\theta(\alpha^2-1)+1)^2}$

接下来的问题是如何生成一个符合这个概率的随机数：

###### 逆变换方法

首先计算 $pdf(x)$ 的累计分布函数 $P(x)$，它的值域是 $[0, 1]$，然后求反函数 $P^{-1}(x)$ 。

这样就可以利用 $[0,1]$ 之间的均匀随机数生成符合 $pdf(x)$ 的随机数。

为了方便起见，我们可以抽样 $x=cos\theta$，推导（因为是抽样 $cos$ 故从t积到1）：
$$
\begin{aligned}
p(x)=&\frac{2\alpha^2x}{(x^2(\alpha^2-1)+1)^2}, x\in[0,1]\\
P(t)=&\int_t^1\frac{2\alpha^2x}{(x^2(\alpha^2-1)+1)^2}dx\\
=&\int_t^1\frac{a^2}{u^2(a^2-1)}du,u=x^2(a^2-1)\\
=&\frac{a^2}{(a^2-1)(t^2(a^2-1)+1)}-\frac{1}{a^2-1}\\
P^{-1}(x)=&\sqrt \frac{1-x}{x(a^2-1)+1}
\end{aligned}
$$
故随机抽样 $x\in [0,1]$，然后得出 $\theta=\arccos\sqrt{\frac{1-x}{x(a^2-1)+1}}$。我们始终忽略了 $\phi$ 这一项，事实上在 $\theta$ 确定后它的概率是均匀的，在 $[0,2\pi]$ 上随机即可。



##### G：Schlick-GGX

$$
G_{schlickGGX}(v)=\frac{n\cdot v}{(n\cdot v)(1-k)+k}
$$

其中 $v$ 为光线方向，显然角度越大，这个项越小（衰减越重），而其中 $k$ 是 $\alpha$ 的重映射，$k = \frac{(1+\alpha)^2}{8}$，也有其他形式的 $k$。

实际上我们要同时考虑入射和出射方向的几何遮蔽，$G=G(w_i) G(w_o)$



##### F：Fresnel-Schlick

一种近似求法
$$
F=F_0+(1-F_0)(1-h\cdot w_i)^5
$$
$F_0$ 为处于0度角上的菲涅尔项，它算起来麻烦，可以直接查表得出。

或使用这样一种估计手段：`F_0=mix(vec3(0.04), baseColor, metallic)`，因为金属的反射率一般是带有色彩的，且 $F_0$ 值自然较高。



