

先行笔记：线性代数的本质



#### 3维叉乘顺序

通常我们使用的是右手定则决定叉乘方向，且定义三维坐标系下 $x\times y=z$，同时还有 $y\times z=x$，$z\times y = x$（注意不是 $y\times z=x$）

如果反复写很多遍 $xyzxyzxyz$，可以发现任意相邻两个叉乘可以得到第三个（循环对称性）

许多时候我们会利用对称性来“照抄”（如写绕y轴旋转的矩阵），要注意这三个轴是循环对称而非按顺序对称的。



#### 四元数

四元数是用来表达旋转的，其主要用途在于计算两个旋转之间的插值（用旋转矩阵很难计算）

正常用矩阵表达Transform的话，只需要掌握矩阵和四元数之间的转换方法即可（先画饼）。



#### LookAt矩阵/View变换

给定相机位置，以及表示朝向的三个轴（给定两个即可（前向和上轴）），如何构建相机的Transform和观察变换矩阵？

位移略过不谈，旋转时将三个轴填入矩阵即可。

值得注意的是，如果我们需要其逆变换（mv变换时常用），只需要对左上矩阵做转置。

因为旋转矩阵是一个正交矩阵，有 $A^{-1}=A^T$



#### 投影矩阵

“投影”直观上容易被理解为将三维空间物体变换到二维屏幕的过程（可以有这样一种降维的线性变换），但如果直接用矩阵来做这样一件事，不方便处理深度信息（遮挡效果）。

故实际上我们说的投影矩阵，是将三维空间中的一个长方体或平头截体（观察区域）映射到标准立方体（Canonical Cube，$[-1, 1]^3$）的过程，这个空间也叫裁剪空间。映射到这里的好处是方便进行后续操作。

##### 正交投影

将一个长方体映射到 $[-1,1]^3$，比较简单



##### 透视投影

透视投影的观察区域是一个平头截体，我们希望也使用一种（四维矩阵可表示的）线性变换将它映射到 $[-1,1]^3$。

思路：首先进行的是一个“压扁”的缩放过程，令远处的平面缩放幅度更大，近平面不变，使得平头截体变成一个长方体，随后进行正交投影。

最简单的想法：用相似三角形，让一条观察射线（朝-z方向）上所有 $x,y$ 坐标缩放后都相同，先假定 $z$ 轴不变

编出一个变换矩阵，其中参数 $n$ 为近平面的 $z$ 坐标
$$
\begin{bmatrix}
n&0&0&0\\
0&n&0&0\\
?&?&?&?\\
0&0&1&0\\
\end{bmatrix}
\times
\begin{bmatrix}
x\\
y\\
z\\
1\\
\end{bmatrix}
=
\begin{bmatrix}
nx\\
ny\\
z^2\\
z\\
\end{bmatrix}
\rightarrow
\begin{bmatrix}
n/z\times x\\
n/z\times y\\
z\\
1\\
\end{bmatrix}
$$

我们发现1，2，4行的参数都很容易确定，但是第三行似乎没法搞？

问题出现了，这样的变换似乎不是一个线性变换（即使在四维下）

那么只能放弃追求 $z$ 轴不变了。

实际的投影矩阵要求只有：近平面坐标不变，以及远平面的z轴（$f$）不变

$$
\begin{bmatrix}
n&0&0&0\\
0&n&0&0\\
0&0&A&B\\
0&0&1&0\\
\end{bmatrix}
\times
\begin{bmatrix}
x\\
y\\
n\\
1\\
\end{bmatrix}
=
\begin{bmatrix}
nx\\
ny\\
n^2\\
n\\
\end{bmatrix}
$$

$$
\begin{bmatrix}
n&0&0&0\\
0&n&0&0\\
0&0&A&B\\
0&0&1&0\\
\end{bmatrix}
\times
\begin{bmatrix}
x\\
y\\
f\\
1\\
\end{bmatrix}
=
\begin{bmatrix}
nx\\
ny\\
f^2\\
f\\
\end{bmatrix}
$$
$$
An+B=n^2\\
Af+B=f^2\\
A = n + f\\
B = -nf
$$



由此得到了这个压缩矩阵：
$$
\begin{bmatrix}
n&0&0&0\\
0&n&0&0\\
0&0&n+f&-nf\\
0&0&1&0\\
\end{bmatrix}
$$

#### 投影后

经过一个简单的平移+缩放，可以将 $x,y$ 从 $[-1,1]$ 映射到 $[0,w]$ 和 $[0,h]$（屏幕空间），这被称为视口变换。

然后对所有的三角形进行光栅化。

