光线追踪和光栅化是两套东西，故新立一个笔记，先丢下之前的流程。



#### 光线与平面求交

光线可以表示为 $r=o+td$，其中 $o$ 为原点，$d$ 为方向。

##### 隐式表面

隐式表面定义为 $f(p)=0$

则求解 $f(o+td)=0$ 即可，取 $t$ 最小值（$t>0$）对应处作为交点。

##### 显示表面

光线与三角形求交：

首先计算光线与三角形所在平面的交点，然后计算点是否在三角形内。

平面的方程：$f(p)=(p-p')\cdot N=0$，$p'$ 为平面上任意点，$N$ 为平面的任意垂线，而从三角形得出这样的平面参数很简单。

 另一种方式：列出三角形面的方程（重心坐标），得到 $O+tD=(1-u-v)P_0+uP_1+vP_2$，它可以写作一个线性方程组，解得 $t,u,v$，然后判断重心坐标是否都在 $[0,1]$ 内。

此处碰撞得到的 $u,v$ 可以记录下来，之后用这个坐标获取表面材质信息。



#### AABB

轴对齐包围盒（Axis-Aligened Bounding Box）

求光线与包围盒是否相交：包围盒有三个对面，计算光线与每对面相交的两个 $t$ 值（$t_{min}$ 和 $t_{max}$），得到三组 $t$ 的区间，这三组的区间的交集即为光线在盒子中的时间。



#### Grid方法

旧方法

将区域划分为很多个格子，计算每个格子中是否有物体，光线进入时可以采用类似Bresenham的方法计算接触的格子（很快），若格子中有物体再检测。



#### 空间划分方法

##### 八叉树

每次划分都划分为8块，直到区域不包含内容或者足够小

##### KD-Tree

每次仅将区域划分为2块，采用某种策略选取最优的划分位置和方向。

划分的方向还是平行的

中间节点都是包围盒，物体都存在叶子节点中。

麻烦的问题：一个物体被划到多个盒子中

##### BSP-Tree

在KD-tree的基础上，划分方向可以是斜的，划分效果可能更好，但计算效率并不优秀。

##### BVH

Bounding Volume Hierarchy

基于物体的划分，而非基于空间的划分。（实现简单，效率不错，广泛使用）

和KD-Tree差不多，但是划分时不再是将空间一刀划开，而是将其中物体分为两个部分，两个部分各自形成一个包围盒，这两个包围盒**可以重叠**，包围盒仅考虑其**完全包围**的物体。

划分后可以接着划分，仅在叶子节点存储实际的物体（指针），数据结构上和KD-Tree类似

这样下来，所有物体都能被覆盖到，注意一些物体可能被重复覆盖（即在左子树，又在右子树），一般碰撞检测仅找最早的碰撞点，它不影响。

实现起来非常容易，可以直接根据父包围盒三维的长度，在最长的一维上，按三角形个数划分（一半划到左一半划到右，$O(n)$ 找出中位数即可）。

###### SAH优化

按三角形个数进行的划分有显而易见的问题，当出现特别大时三角形时，划分不那么均匀，重叠部分也可能非常大。

SAH优化即按照包围表盒面积来确定一个最优的划分方案，需要排序然后尝试三个轴上的所有划分点，用个前后缀max，min。构建时需要sort，但求交时能显著加快。



#### Radiometry

##### 立体角

`steradians`

二维角度的标准定义（弧度）：$\theta=\frac{l}{r}$，弧长/半径

三维立体角的定义：$w = \frac{A}{r^2}$，弧面面积/半径方

单位立体角：

在球面上 $(\theta,\phi)$ （先绕z轴转 $\theta$ 角，再绕y轴转 $\phi$ 角）处，画图容易计算弧面的微分
$$
d_A=(rd_\theta)(rsin_\theta d_\phi)
$$
则有单位立体角（微分立体角）
$$
d_w=\frac{d_A}{r^2}=sin_\theta d_\theta d_\phi
$$
立体角积分：
$$
\theta\leq \pi,\phi\leq 2\pi\\
w=\int_0^{2\pi}\int_0^{\pi} sin_\theta d_\theta d_\phi=4\pi
$$


##### 辐射度量学

Radiant Energy：辐射能量 $Q$

Radiant flux(power)：辐射通量，单位时间发出的能量 $\phi=\frac{dQ}{dt}$，类似功率。通量也可以理解为单位时间通过的光子数量。单位有流明 `lumen`

- 事实上，渲染中我们通常不会考虑辐射能量，通常都是考虑Flux(Power)。

Intensity：光强，点光源发出的，在单位立体角上的Power，$I=\frac{d\phi}{dw}$，或 $I=\frac{\phi}{4\pi}$

Irradiance：辐照度，单位面积上接受到的Power，$E=\frac{d\phi}{dA}$，这个面积是指**垂直接收光**的面积，可以看做是一个单位面积的小球 $dA$ 垂直接收到的来自四面八方的辐射量。具体计算时，应当根据面的方向再乘上一个cos

- 点光源自由发散时，随距离增大，Intensity不变（单位立体角上的光强没变），接受者的Irradiance按 $r^2$ 衰减。

Radiance：单位面积接收到单位立体角的Power，我倾向于理解它是特定方向上的Irradiance
$$
L=\frac{d^2\phi}{d_wd_Acos_\theta}
$$
上述几个量其实都可以从接收和发送两个方面来理解，这本质是由于光路的可逆性，不过理解时为了避免混淆，我们可以脑子里只当Irradiance是接收方的量，Intensity是发送方的量。



#### 渲染方程

$$
L_o(p,w_o)=L_e(p,w_o)+\int_{\Omega^+}L_i(p,w_i)f_r(p,w_i\rightarrow w_o)cos\theta_idw_i
$$
其中，$w$ 表示一个方向，$dw$ 为这个方向上的微分立体角。

$w_r$ 方向上的辐射，等于自身在这个方向的发光（辐射）加上所有其他方向 $w_i$ 入射的光反射对 $w_r$ 的贡献。$f_r(p,w_i\rightarrow w_r)$ 是一个**BRDF方程**，定义了一个方向的入射光对另一个方向出射光的贡献，通过定义不同的BRDF方程可以实现不同的材质。

渲染方程是递归定义的，是**正确的**，这里的正确指它完全符合现实世界，但我们实现时还是需要用到一点近似，或者说仅仅实现“**期望上正确**”。

$cos\theta_i$ 为什么不写进BRDF？

这里的 $cos\theta_i$ 是出于几何关系考虑的，从 $w_i$ 这个方向上来的 $L_i$ 只有一部分能到达平面，从平面材质角度出发，这个方向上来的Radiance就这么多。这样BRDF考虑能量守恒关系也更好考虑。



#### 蒙特卡洛方法

随机采样。

通用形式（使用任何分布的概率来采样），近似地求 $f(x)$ 的定积分，定积分域蕴含在随机变量 $X$ 中。
$$
\frac{1}{N}\sum_{i=1}^N \frac{f(X_i)}{p(X_i)}
$$
渲染方程应用蒙特卡洛方法之后（这里暂时忽略了自发光）：
$$
L_o(p,w_o)=\frac{1}{N}\sum_{i=1}^N \frac{L_i(p,w_i)f_r(p,w_i\rightarrow w_o)(n\cdot w_i)}{p(w_i)}
$$

注意：上式考虑到了 $X$ 的概率密度，故一定要按照 $X$ 的分布来抽样，而不能人为干预，否则结果的期望就不正确了。

##### 重要性采样

采样蒙特卡洛方法可以使用任何分布的概率，都正确，而使用特殊的分布可以提升效果（准确来说，能够降低采样结果的方差）。

一个简单的想法就是：使概率密度函数和要求积的 $f(x)$ 形状差不多，应当是最有效的。

具体内容写在BRDF与材质中。



#### 路径追踪

问题：即使随机采样，还是会出现指数爆炸的问题

- N = 1，仅反射一次，这样得到的图像会有大量噪声。
  - 每个像素发出多根光线以平均
  - 后期去噪

问题：无限递归

- 当然可以简单设置反弹次数，但不够好
- 设置一个概率 $p$，以概率 $p$ 往外反弹一次，得到的结果再除以 $p$，这样可以维护期望不变，场景亮度是真实的。

优化：直接光照、间接光照划分

- 思路：将直接光照和间接光照分开计算（分别划分到球面上的一块区域，各应用用蒙特卡洛方式积分）

- 因直接光照贡献较大，随机一条直线很可能碰不到直接光，故单独计算。

  - 面光源：在立体角上的采样改为**在光源面上**的采样。我们将光源面投影到立体角，得到映射关系 $dw = \frac{cos\theta'}{\|x'-p\|^2}dA$，其中 $x'$ 是在光源面上的抽样，$\theta'$ 是 $xx'$ 连线与光源面法线的夹角，直接光照的贡献为：
    $$
    L_o'=AL_i(p,w_i)f_r(p,w_i\rightarrow w_o)cos\theta\frac{cos\theta'}{\|x'-x\|^2}
    $$

  - 这是在光源面上均匀抽样了一个点，概率为 $1/A$，然后将对 $w$ 的积分改为对 $A$ 的积分。可以发现，这里实际上还蕴含了 $r^2$ 的距离衰减。

  - $xx'$ 连线若中间撞到其他物体，则直接光贡献为0

  - 点光源很难处理，一般可以使用微小的面光源代替

- 计算间接光照，若随机到的方向撞上了光源，则贡献为0

![](http://lxtyin.ac.cn/img/Gemo/tracing1.png)

这里我将球面看做ABC三部分，直接光照求B+C段的蒙特卡洛积分，但将C段贡献视为0；间接光照求A+B+C段的蒙特卡洛积分，但将B段贡献视为0，故直接光照与间接光照相加，恰好为整个球面上的积分。至此，路径追踪仍然保持了**期望上的正确性**。





#### 采样方法

##### 三角形均匀采样

事实上这并不容易做到（要均匀采样）

有个公式：$P=(1-\sqrt{r_1})A+(\sqrt{r_1}(1-r_2)B+(r_2\sqrt{r_1})C$

其中 $r_1, r_2$ 是 $[0,1]$ 之间的均匀随机数



#### 其他一些东西

`pixel reconstruction filter`

`gamma correction`

`Metropolis Light Transport`

`Photon Mapping`

